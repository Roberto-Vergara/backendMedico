<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realizar An√°lisis - Plataforma de Orientaci√≥n</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="CSS/style.css">
<style>
/* --- POPUP --- */
.popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    background-color: #222;
    color: #fff;
    padding: 20px 25px;
    border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.35s ease, transform 0.35s ease;
    z-index: 1000;
    max-width: 340px;
    width: 85%;
    text-align: center;
    line-height: 1.4;
    font-size: 0.95rem;
}
.popup.show {
    opacity: 1;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
}
.popup button {
    background: #ff5252;
    border: none;
    color: #fff;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: background 0.3s ease;
}
.popup button:hover { background: #e04848; }
.popup strong { color: #4fc3f7; }
.loading-spinner {
    border: 4px solid rgba(255,255,255,0.2);
    border-top: 4px solid #4fc3f7;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    margin: 8px auto;
    animation: spin 1s linear infinite;
}
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* --- SECCI√ìN CUT√ÅNEA MEJORADA --- */
#skin-lesion-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-section {
    background: #f9fafb;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.form-section h3 {
    margin-bottom: 15px;
    color: #333;
    font-size: 1.05rem;
    font-weight: 600;
}

.form-section label {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 15px;
    color: #444;
    font-weight: 500;
    font-size: 0.9rem;
}

.form-section input[type="number"],
.form-section select,
.form-section input[type="file"] {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 0.9rem;
    background: #fff;
    transition: border 0.2s ease, box-shadow 0.2s ease;
}

.form-section input[type="number"]:focus,
.form-section select:focus,
.form-section input[type="file"]:focus {
    outline: none;
    border-color: #4fc3f7;
    box-shadow: 0 0 0 3px rgba(79,195,247,0.2);
}

.form-section input[type="file"] {
    cursor: pointer;
    border: 2px dashed #ccc;
    background: #fff;
    transition: all 0.3s ease;
}

.form-section input[type="file"]:hover {
    border-color: #4fc3f7;
    background: #f0f8ff;
}

.form-section input[type="file"]::file-selector-button {
    background: #4fc3f7;
    border: none;
    color: #fff;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 10px;
    font-weight: 600;
    transition: background 0.3s ease;
}
.form-section input[type="file"]::file-selector-button:hover {
    background: #29b6f6;
}

/* Layout de datos del paciente */
.form-section .data-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
}

/* Bot√≥n de env√≠o */
.submit-btn.analisis {
    background: #4fc3f7;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 12px 18px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    align-self: flex-start;
    transition: background 0.3s ease, transform 0.2s ease;
}
.submit-btn.analisis:hover {
    background: #29b6f6;
    transform: scale(1.03);
}

/* --- Estilo mejorado para selecci√≥n de s√≠ntomas --- */
.symptoms-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
    max-height: 320px;
    overflow-y: auto;
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 10px;
    background: #fafafa;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
}
.symptom-item {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}
.symptom-item:hover {
    background: #f0f8ff;
    border-color: #4fc3f7;
    transform: scale(1.02);
}
.symptom-item input[type="checkbox"] {
    accent-color: #4fc3f7;
    width: 18px;
    height: 18px;
    cursor: pointer;
}
.symptom-item label {
    cursor: pointer;
    flex: 1;
    color: #333;
}
.symptoms-grid::-webkit-scrollbar { width: 8px; }
.symptoms-grid::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.2);
    border-radius: 4px;
}
.symptoms-grid::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0,0,0,0.35);
}
</style>
</head>

<body>
<header class="page-header">
    <a href="/" class="back-link">&larr;Volver al Inicio</a>
    <h1>Formularios de An√°lisis</h1>
</header>

<main>
    <!-- 1. An√°lisis cut√°nea -->
    <div class="prediction-card collapsible"> 
        <div class="card-header">
            <h2>1. An√°lisis de Lesiones Cut√°neas</h2>
            <span class="collapse-icon">+</span> 
        </div>
        <div class="card-body">
            <form id="skin-lesion-form" enctype="multipart/form-data">
                <div class="form-section">
                    <h3>üì∏ Carga de Imagen</h3>
                    <input type="file" id="image-upload" name="img" accept="image/*" required>
                </div>
                <div class="form-section">
                    <h3>üßç Datos del Paciente</h3>
                    <div class="data-grid">
                        <label>Edad:
                            <input type="number" id="age" name="age_approx" placeholder="A√±os" required>
                        </label>
                        <label>G√©nero:
                            <select id="gender" name="sex" required>
                                <option value="">Seleccione...</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                                <option value="otro">Otro</option>
                            </select>
                        </label>
                        <label>Localizaci√≥n de la lesi√≥n:
                            <select id="location" name="anatom_site_general" required>
                                <option value="">Seleccionar...</option>
                                <option value="1">Cabeza</option>
                                <option value="0">Otra parte del cuerpo</option>
                            </select>
                        </label>
                        <label>Caracter√≠stica principal:
                            <select id="lesion_type" name="melanocytic" required>
                                <option value="">Seleccionar...</option>
                                <option value="nevus_melanocitico">Lunar</option>
                                <option value="queratosis">Queratosis</option>
                                <option value="carcinoma">Carcinoma</option>
                                <option value="otro">Otro / No s√©</option>
                            </select>
                        </label>
                    </div>
                </div>
                <button type="submit" class="submit-btn analisis">üîç Analizar Lesi√≥n</button>
            </form>
        </div>
    </div>

    <!-- 2. S√≠ntomas generales -->
    <div class="prediction-card collapsible">
        <div class="card-header">
            <h2>2. Orientaci√≥n por S√≠ntomas Generales</h2>
            <span class="collapse-icon">+</span>
        </div>
        <div class="card-body">
            <form id="general-symptoms-form">
                <div class="form-section">
                    <h3>Seleccione hasta 3 s√≠ntomas</h3>
                    <div id="symptoms-container" class="symptoms-grid"></div>
                </div>
                <br>
                <button type="submit" class="submit-btn">Obtener Orientaci√≥n</button>
            </form>
        </div>
    </div>
</main>

<div id="popup" class="popup">
    <span id="popup-text"></span>
    <button onclick="closePopup()">Cerrar</button>
</div>

<script src="JS/rec.js"></script>
<script>
/* --- COLAPSABLES --- */
document.querySelectorAll('.card-header').forEach(header=>{
    header.addEventListener('click', ()=>{
        const body = header.nextElementSibling;
        body.classList.toggle('active');
        const icon = header.querySelector('.collapse-icon');
        icon.textContent = body.classList.contains('active') ? '‚àí' : '+';
    });
});

/* --- POPUPS --- */
function showPopup(msg){const p=document.getElementById("popup");const t=document.getElementById("popup-text");t.innerHTML=msg;p.classList.add("show");}
function closePopup(){document.getElementById("popup").classList.remove("show");}
function showLoadingPopup(msg){const p=document.getElementById("popup");const t=document.getElementById("popup-text");t.innerHTML=`<div class="loading-spinner"></div><strong>${msg}</strong>`;p.classList.add("show");p.querySelector("button").style.display="none";setTimeout(()=>{p.classList.remove("show");p.querySelector("button").style.display="block";},2000);}
function showDetailedPopup(pred,desc,rec,esp,img=null){const p=document.getElementById("popup");const t=document.getElementById("popup-text");t.innerHTML=`<h3 style="margin-bottom:8px; font-size:1rem;">ü©∫ Resultado del An√°lisis</h3>${img?`<img src="${img}" alt="resultado" style="max-width:90%; border-radius:8px; margin-bottom:8px;">`:""}<strong>Predicci√≥n:</strong> ${pred}<br><br><strong>Descripci√≥n:</strong> ${desc||"No disponible."}<br><br><strong>Recomendaci√≥n:</strong> ${rec||"No disponible."}<br><br><strong>Especialista:</strong> ${esp||"No especificado."}`;p.classList.add("show");}

/* --- FORMULARIO CUT√ÅNEA --- */
document.getElementById("skin-lesion-form").addEventListener("submit",async e=>{
    e.preventDefault();
    const file=document.getElementById("image-upload").files[0];
    if(!file) return showPopup("Selecciona una imagen");
    const formData=new FormData();
    formData.append("img",file);
    formData.append("age_approx",document.getElementById("age").value);
    formData.append("sex",document.getElementById("gender").value);
    formData.append("anatom_site_general",document.getElementById("location").value);
    formData.append("melanocytic",document.getElementById("lesion_type").value);
    showLoadingPopup("Analizando imagen...");
    try{
        const response=await fetch("http://localhost:3000/python/analizarCutanea",{method:"POST",body:formData});
        if(!response.ok) throw new Error("Error al enviar la imagen");
        const data=await response.json();
        showDetailedPopup(`${data.tipo}`,"Lesi√≥n detectada seg√∫n la imagen proporcionada.","Se recomienda evaluaci√≥n presencial si persiste la lesi√≥n.","Dermat√≥logo",URL.createObjectURL(file));
    }catch(err){console.error(err);showPopup("Error al enviar la imagen");}
});

/* --- S√çNTOMAS GENERALES --- */
const sintomasES={
'abdominal_pain':'Dolor abdominal','acidity':'Acidez','altered_sensorium':'Alteraci√≥n del sensorio','anxiety':'Ansiedad','back_pain':'Dolor de espalda','bladder_discomfort':'Molestia en la vejiga','bloody_stool':'Heces con sangre','blurred_and_distorted_vision':'Visi√≥n borrosa','breathlessness':'Falta de aire','burning_micturition':'Dolor al orinar','chest_pain':'Dolor en el pecho','chills':'Escalofr√≠os','cold_hands_and_feets':'Manos y pies fr√≠os','constipation':'Estre√±imiento','continuous_feel_of_urine':'Sensaci√≥n continua de orinar','continuous_sneezing':'Estornudos continuos','cough':'Tos','dark_urine':'Orina oscura','dehydration':'Deshidrataci√≥n','diarrhoea':'Diarrea','dizziness':'Mareos','extra_marital_contacts':'Contactos extramaritales','fatigue':'Fatiga','foul_smell_of urine':'Olor desagradable de la orina','headache':'Dolor de cabeza','high_fever':'Fiebre alta','hip_joint_pain':'Dolor cadera','indigestion':'Indigesti√≥n','joint_pain':'Dolor en articulaciones','knee_pain':'Dolor de rodilla','lethargy':'Letargo','loss_of_appetite':'P√©rdida de apetito','loss_of_balance':'P√©rdida de equilibrio','mood_swings':'Cambios de √°nimo','movement_stiffness':'Rigidez de movimientos','muscle_wasting':'Desgaste muscular','muscle_weakness':'Debilidad muscular','nausea':'N√°useas','neck_pain':'Dolor de cuello','pain_during_bowel_movements':'Dolor al defecar','pain_in_anal_region':'Dolor zona anal','patches_in_throat':'Manchas en garganta','restlessness':'Inquietud','silver_like_dusting':'Polvo plateado en piel','skin_peeling':'Descamaci√≥n piel','skin_rash':'Erupci√≥n cut√°nea','spinning_movements':'Sensaci√≥n de giro','stiff_neck':'Rigidez de cuello','stomach_pain':'Dolor de est√≥mago','sunken_eyes':'Ojos hundidos','sweating':'Sudoraci√≥n','swelling_joints':'Inflamaci√≥n articulaciones','swelling_of_stomach':'Inflamaci√≥n est√≥mago','ulcers_on_tongue':'√ölceras en lengua','vomiting':'V√≥mitos','weakness_in_limbs':'Debilidad extremidades','weakness_of_one_body_side':'Debilidad de un lado del cuerpo','weight_gain':'Aumento de peso','weight_loss':'P√©rdida de peso','yellowish_skin':'Piel amarillenta','itching':'Picaz√≥n'};
const container=document.getElementById("symptoms-container");
Object.keys(sintomasES).forEach(key=>{
    const div=document.createElement("div");
    div.className="symptom-item";
    const input=document.createElement("input");
    input.type="checkbox";input.name="symptoms";input.value=key;input.id=key;
    const label=document.createElement("label");
    label.htmlFor=key;label.textContent=sintomasES[key];
    div.appendChild(input);div.appendChild(label);
    container.appendChild(div);
});
container.addEventListener("change",e=>{
    const checked=container.querySelectorAll("input[type=checkbox]:checked");
    if(checked.length>3){e.target.checked=false;showPopup("Solo puedes seleccionar hasta 3 s√≠ntomas.");}
});
document.getElementById("general-symptoms-form").addEventListener("submit",async e=>{
  e.preventDefault();
  const checked=Array.from(container.querySelectorAll("input[type=checkbox]:checked")).map(cb=>cb.value);
  if(checked.length===0) return showPopup("Selecciona al menos un s√≠ntoma.");
  showLoadingPopup("Cargando orientaci√≥n...");
  try{
    const response=await fetch("http://localhost:3000/python/preGeneral",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symptoms:checked})});
    const data=await response.json();
    if(!data.prediction){showPopup("No se pudo obtener la predicci√≥n.");return;}
    const rec=enfermedadRecomendacion(data.prediction);
    showDetailedPopup(data.prediction,rec.descripcion,rec.recomendacion,rec.especialista);
  }catch(err){console.error(err);showPopup("Error al enviar los s√≠ntomas.");}
});
</script>
</body>
</html>
